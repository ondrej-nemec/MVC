<html>
<head>
	<title>GRID</title>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

<script src="/grid/grid.js" crossorigin="anonymous"></script>

</head>
<body>

	<div id="uniqueName">
	</div>
	
<script type="text/javascript">
var gridConfig = {
		"Name": "uniqueName",
		"Unique": "id",
		"Columns": [
			{
				"name": "",
				"title": "Actions",
				"type": "actions",
				"sorting": false
			},
			{
				"name": "id",
				"sorting": true,
				"type": "value",
				"size": 4,
				"max": 1,
				"min": 5
			},{
				"name": "name",
				"title": "Name",
				"filter": "text", // missing means no filter; text | select | datetime ( | number | checkbox ) ??
				"sorting": true,
				"type": "value"
			},{
				"name": "age",
				"title": "Age",
				"filter": "number",
				"sorting": true,
				"type": "value"
			},{
				"name": "datetime",
				"title": "Datetime",
				"filter": "number",
				"filter": "datetime",
				"sorting": true,
				"type": "value"
			},{
				"name": "maried",
				"title": "Is Married",
				"sorting": true,
				"type": "value",
				"filter": "select",
				"options": [
					{
						"value": "",
						"text": '----'
					},
					{
						"value": "0",
						"text": "NO"
					},
					{
						"value": "1",
						"text": "YES"
					}
				],
				"renderer": function(value) {
					if (value === 'false') {
						return "NO";
					} else if (value === 'true') {
						return "YES";
					}
				}
			},
			{
				"name": "",
				"title": "Buttons",
				"sorting": false,
				"type": "buttons",
				"buttons": [
					{
						"class": "",
						"title": "Button",
						"href": function(row) {
							return ""
						},
						"method": "DELETE",// only if ajax == true
						"params": function(row) {
							// only if ajax == true
						},
						"onSuccess": function(row) {
							// only if ajax == true
						},
						"onFailure": function(row) {
							// only if ajax == true
						},
						"confirmation": function(row) {
							console.log("confirmation", row);
							return true;
						},
						"ajax": true
					},
					{
						"class": "",
						"title": "Button2",
						"href": function(row) {
							return "/1.png";
						},
						"confirmation": function(row) {
							console.log("confirmation", row);
							return true;
						},
						"ajax": false
					}
				]
			}
		],
		"DataUrl": "/base/grid/items", // "grid-content.json",
		"DataMethod": "GET",
		"pagesButton": 5,
		"pageSizes": [5, 10, 15],
		"pageSizeDefault": 10,
		"Actions": [
			{"title": "Action 1", "link": "/base/grid/action"},
			{"title": "Action 2", "link": "/base/grid/action"},
			{"title": "Not existing Action", "link": "not-existing.json"},
			{"title": "Synchro Action", "link": "/grid-old/jsgrid-1.5.3.zip", "ajax": false}
		]
	};
// simpleGrid.init('#uniqueName', gridConfig);
totiControl.init('#uniqueName', gridConfig, "grid");
</script>

<!-- 
<script type="text/javascript">
	var gridConfig = {
		"Name": "uniqueName",
		"Unique": "id",
		"Columns": [
			{
				"name": "",
				"title": "Actions",
				"type": "actions",
				"sorting": false
			},
			{
				"name": "id",
				"sorting": true,
				"type": "value"
			},{
				"name": "name",
				"title": "Name",
				"filter": "text", // missing means no filter; text | select | datetime ( | number | checkbox ) ??
				"sorting": true,
				"type": "value"
			},{
				"name": "age",
				"title": "Age",
				"filter": "datetime",
				"sorting": true,
				"type": "value"
			},{
				"name": "maried",
				"title": "Is Married",
				"sorting": true,
				"type": "value",
				"filter": "select",
				"select_options": [
					{
						"value": "",
						"text": '----'
					},
					{
						"value": "0",
						"text": "NO"
					},
					{
						"value": "1",
						"text": "YES"
					}
				],
				"renderer": function(value) {
					if (value === false) {
						return "NO";
					} else if (value === true) {
						return "YES";
					}
				}
			},
			{
				"name": "",
				"title": "Buttons",
				"sorting": false,
				"type": "buttons",
				"renderer": function(item) {
					return $('<button>').text("detail");
				}
			}
		],
		"DataUrl": "grid-content.json",
		"pagesButton": 5,
		"pageSizes": [5, 10, 15],
		"pageSizeDefault": 10,
		"Actions": [
			{"title": "Action 1", "link": "grid-content.json"},
			{"title": "Action 2", "link": "grid-content.json"},
			{"title": "Action 3", "link": "not-existing.json"}
		]
	};

	$(document).ready(function() {
		$('#uniqueName').html(grid_createTableContainer(gridConfig));
		grid_loadData(gridConfig, true);
	});

	function grid_createTableContainer(gridConfig) {
		var table = $('<table>');
		table.append(grid_createHeader(gridConfig)).append(grid_createBody(gridConfig));
		return $('<div>').attr("class", "grid").attr("id", gridConfig.Name + "-grid").append(table).append(grid_createFooter(gridConfig));
	}
	function grid_createHeader(gridConfig) {
		// column names with sorting
		var names = $('<tr>').attr("id", gridConfig.Name + "-sorting");
		gridConfig.Columns.forEach(function(column, index) {
			var cell = $('<a>');
			if (column.sorting) {
				cell.attr("href", "").attr("data-sort", 0).click(function() {
					var sortType = $(this).data('sort') + 1;
					if (sortType === 3) {
						$(this).data('sort', 0);
					} else {
						$(this).data('sort', sortType);
					}
					$(this).children(".sortType").hide();
					$(this).children(".type" + sortType).show();
					grid_loadData(gridConfig);
					return false;
				});
				cell.append($('<i>').attr("class", "far fa-clock sortType type1").hide());
				cell.append($('<i>').attr("class", "fas fa-clock sortType type2").hide());
			}
			if (column.hasOwnProperty('title')) {
				cell.append(column.title);
			} else {
				cell.append(column.name);
			}
			names.append($('<td>').attr("data-name", column.name).html(cell));
		});
		// filters
		var filters = $('<tr>').attr("id", gridConfig.Name + "-filtering");
		gridConfig.Columns.forEach(function(column, index) {
			var cell = $('<td>').attr("data-name", column.name);
			if (column.type === "actions") {
				cell.html($('<input>').attr('type', "checkbox").click(function() {
					$('.' + gridConfig.Name + '-grid-action').prop('checked', $(this).prop('checked'));
				}));
			} else if (column.hasOwnProperty('filter')) {
				switch(column.filter) {
					case 'text':
						cell.html('<input type="text" />'); 
						break;
					case 'select':
						var select = $('<select>');
						column.select_options.forEach(function(option, index) {
							select.append($('<option>').attr("value", option.value).text(option.text));
						});
						cell.html(select);
						break;
					case 'datetime':
						cell.html('<input type="datetime-local" />');
						break;
					default: console.log("Mising filter type " + column.filter);
				}
				cell.change(function() {
					grid_loadData(gridConfig);
				});
			} else {
				cell.text('');
			}
			filters.append(cell);
		});
		return $('<thead>').append(names).append(filters);
	}
	function grid_createBody(gridConfig) {
		return $('<tbody>'); // empty, data loaded after 
	}
	function grid_createFooter(gridConfig) {
		// pages
		var pages = $('<div>').attr("id", gridConfig.Name + "-actualPage");
		// actions
		var actions = $('<div>');
		var select = $('<select>').append($('<option>').attr("value", '').text('---'));
		gridConfig.Actions.forEach(function (item, index) {
			select.append($('<option>').attr("value", item.link).text(item.title));
		});
		select.change(function() {
			$(this).next("a").attr("href", $(this).val());
		});
		var button = $('<a>').attr("href", "").click(function() {
			var ids = [];
			$('.' + gridConfig.Name + "-grid-action:checked").each(function() {
				ids.push($(this).data("unique"));
			});
			$.ajax({
				url: $(this).attr("href"),
				data: {
					uniques: ids
				},
			}).done(function(res) {
				// TODO
				console.log("success", res);
			}).fail(function(xhr, re, error) {
				// TODO
				console.log(xhr, re, error);
			});
			return false;
		}).text('Execute'); // TODO translate
		actions.append(select).append(button);
		return $('<div>').append(actions).append(pages); // tfoot
	}

	function grid_loadData(gridConfig) {
		grid_loadData(gridConfig, false);
	}

	function grid_loadData(gridConfig, firstLoad) {
		var urlParams = {};
		var search = decodeURIComponent(window.location.search.substring(1));
		if (firstLoad && search !== '') {
			urlParams = JSON.parse('{"' + search.replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}');
			// filters
			$('#' + gridConfig.Name + "-filtering").children('td').each(function() {
				var name = $(this).data('name');
				if (urlParams["filters[" + name + "]"] !== undefined) {
					$(this).children().val(urlParams["filters[" + name + "]"]);
				}
			});
			//sorting
			$('#' + gridConfig.Name + "-sorting").children('td').each(function() {
				var name = $(this).data('name');
				if (urlParams["sorting[" + name + "]"] !== undefined) {
					var val = urlParams["sorting[" + name + "]"];
					var sortType = 0;
					if (val == 'ASC') {
						sortType = 1;
					} else if (val == "DESC") {
						sortType = 2;
					}
					var a = $(this).children("a")
					a.attr("data-sort", sortType);
					a.children(".sortType").hide();
					a.children(".type" + sortType).show();
				}
			});
			// pagging
			$("#" + gridConfig.Name + "-pageSize").val(urlParams.pageSize);
		} else {
			var filters = {};
			$('#' + gridConfig.Name + "-filtering").children('td').each(function() {
				var value = $(this).children().val();
				if (value !== undefined && value !== '') {
					filters[$(this).data('name')] = value;
				}
			});
			var sorts = {};
			$('#' + gridConfig.Name + "-sorting").children('td').each(function() {
				var sort = $(this).children("a").data("sort");
				if (sort !== 0) {
					sorts[$(this).data("name")] = (sort === 1) ? 'ASC' : 'DESC';
				}
			});	
			var pageSize = $("#" + gridConfig.Name + "-pageSize").val();
			var pageIndex = $("#" + gridConfig.Name + "-actualPage").data('actualPage');

			var urlParams = {
					pageIndex: pageIndex === undefined ? 1 : pageIndex,
					pageSize: pageSize === undefined ? gridConfig.pageSizeDefault : pageSize,
					filters: filters,
					sorting: sorts
			};
		}
		$.ajax({
			url: gridConfig.DataUrl,
			method: "GET",
		//	type: "JSON",
			data: urlParams,
			success: function(response) {
				var body = $('#' + gridConfig.Name + "-grid table tbody");
				body.html('');
				if (response.data.length === 0) {
					body.html($('<div>').text("No items fouded")); // TODO translate
					return;
				}
				// load data
				response.data.forEach(function(row, index) {
					var tableRow = $('<tr>');
					gridConfig.Columns.forEach(function(column, index) {
						var td = $('<td>');
						if (column.type === 'actions') {
							td.html($("<input>").attr("type", "checkbox").attr("class", gridConfig.Name + '-grid-action').attr("data-unique", row[gridConfig.Unique]));
						} else if (column.hasOwnProperty("renderer")) {
							if (column.type === 'buttons') {
								td.html(column["renderer"](row));
							} else {
								td.html(column["renderer"](row[column.name]));
							}
						} else {
							td.text(row[column.name]);
						}
						tableRow.append(td);
					});
					body.append(tableRow);
				});
				// reload pages
				grid_showPages(gridConfig, response.pageIndex, response.pageCount);
				// set params in url
				window.history.pushState({"html":window.location.href},"", "?" + jQuery.param(urlParams));
			},
			error: function(xhr,status,error) {
				console.log(xhr, status, error);
				$('#' + response.uniqueName + "-grid table tbody").html($('<div>').text("Loading error")); // TODO translate
			}
		});
	}
	function grid_showPages(gridConfig, actualPage, pageCount) {
		var pages = $("#" + gridConfig.Name + "-actualPage");
		pages.html('');
		pages.data("actualPage", actualPage);

		pages.append($('<scan>').text('Pages:')); // TODO translate
		pages.append('&nbsp;');
		if (actualPage > 1) {
			pages.append($('<a>').text('First').click(grid_pageOnClick(gridConfig, 1, pages))); // TODO translate
			pages.append('&nbsp;');
		}
		if (actualPage > 2) {
			pages.append($('<a>').text('Previos').click(grid_pageOnClick(gridConfig, actualPage - 1, pages))); // TODO translate
			pages.append('&nbsp;');
		}

		var lower = actualPage - Math.floor(gridConfig.pagesButton / 2);
		if (lower < 1) {
			lower = 1;
		}
		for (i = lower; i < Math.min(lower + gridConfig.pagesButton, pageCount); i++) {
			var page = $('<a>').text(i);
			if (i === actualPage) {
				page.attr("class", "actualPage");
			}
			page.click(grid_pageOnClick(gridConfig, i, pages));
			pages.append(page);
			pages.append('&nbsp;');
		}

		if (actualPage < pageCount) {
			pages.append($('<a>').text('Next').click(grid_pageOnClick(gridConfig, actualPage+1, pages))); // TODO translate
			pages.append('&nbsp;');
		}
		if ((actualPage + 1) < pageCount) {
			pages.append($('<a>').text('Last').click(grid_pageOnClick(gridConfig, pageCount, pages))); // TODO translate
			pages.append('&nbsp;');
		}
		pages.append('&nbsp;');
		var pageSizeSelect = $('<select>').attr("id", gridConfig.Name + "-pageSize");
		gridConfig.pageSizes.forEach(function(size, index) {
			pageSizeSelect.append($('<option>').attr("value", size).text(size));
		});
		pageSizeSelect.change(function() {
			grid_loadData(gridConfig);
		});
		pageSizeSelect.val(gridConfig.pageSizeDefault);
		pages.append(pageSizeSelect);
	}
	function grid_pageOnClick(gridConfig, newPage, pages) {
		return function() {
			pages.data("actualPage", newPage);
			grid_loadData(gridConfig);
			return false;
		};
	}

</script>
 -->
</body>
</html>